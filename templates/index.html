<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Escala</title>
    <link rel="icon" type="image/svg+xml" href="https://identidade.adventistas.org/pt/assets/img/iasd_logo.svg">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        /* 1. VARI√ÅVEIS DE CORES E TEMAS (Centraliza√ß√£o de estilos) */
        :root { 
            --primary: #002e5d; 
            --secondary: #6f42c1;
            --bg: #f4f7f6; 
            --white: #ffffff; 
            --border: #dee2e6; 
            --text: #2f3640; 
            --input-bg: #f9f9f9;
            --danger: #e74c3c;
            --success: #2ecc71;
        }

        /* 2. MODO NOTURNO (Substitui√ß√£o das vari√°veis de cor) */
        body.dark-mode {
            --bg: #0f172a;
            --white: #1e293b;
            --border: #334155;
            --text: #f1f5f9;
            --input-bg: #0f172a;
        }

        /* 3. ESTILOS GERAIS E LAYOUT */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); color: var(--text); padding: 8px; margin: 0; transition: background 0.3s; }
        
        /* Cabe√ßalho principal com degrad√™ */
        .header-app { 
            position: relative;
            text-align: center; padding: 30px 10px; 
            background: linear-gradient(135deg, #002e5d 0%, #004a99 100%); 
            margin: -8px -8px 15px -8px; color: white; border-radius: 0 0 30px 30px;
        }
        .logo-header { width: 140px; margin-bottom: 10px; filter: brightness(0) invert(1); }
        .by-header { font-size: 0.7em; opacity: 0.8; margin-top: 5px; font-weight: 300; letter-spacing: 1px; text-transform: lowercase; }

        body.dark-mode .by-header { color: #cbd5e1; opacity: 1; }

        /* Controles flutuantes (DarkMode e Redes Sociais) */
        .side-controls {
            position: absolute; top: 15px; right: 15px;
            display: flex; flex-direction: column; gap: 8px;
            align-items: center;
        }

        .btn-control {
            width: 38px; height: 38px;
            background: rgba(255, 255, 255, 0.15); color: white;
            border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 1.1em; backdrop-filter: blur(4px);
            text-decoration: none; transition: 0.2s;
        }
        .btn-control:hover { background: rgba(255, 255, 255, 0.25); transform: translateY(-2px); }

        /* Container do formul√°rio */
        .container { max-width: 900px; margin: 0 auto; background: var(--white); padding: 15px; border-radius: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .section-title { font-weight: 700; color: var(--primary); margin: 20px 0 10px 0; border-left: 4px solid var(--primary); padding-left: 10px; font-size: 0.85em; text-transform: uppercase; }
        body.dark-mode .section-title { color: #60a5fa; border-color: #60a5fa; }

        .grid-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        label { display: block; font-weight: 600; font-size: 0.75em; color: #747d8c; margin-bottom: 4px; }
        body.dark-mode label { color: #94a3b8; }

        input, select { width: 100%; padding: 10px; border: 2px solid var(--border); border-radius: 10px; box-sizing: border-box; font-size: 0.9em; background: var(--input-bg); color: var(--text); }

        /* 4. COMPONENTES DE GEST√ÉO DE MEMBROS */
        .legenda-dispo { 
            background: #fffbe6; border: 1px solid #ffe58f; padding: 10px; 
            border-radius: 10px; margin-bottom: 15px; font-size: 0.75em; color: #856404;
            display: flex; flex-direction: column; gap: 5px;
        }
        body.dark-mode .legenda-dispo { background: #1e1b0b; border-color: #423b13; color: #fbbf24; }
        .legenda-item { display: flex; align-items: center; gap: 8px; }

        .cadastro-membros { display: flex; gap: 8px; margin-bottom: 15px; }
        .lista-membros { background: var(--input-bg); border-radius: 10px; padding: 10px; max-height: 300px; overflow-y: auto; border: 1px solid var(--border); }
        
        .membro-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px; border-bottom: 1px solid var(--border); background: var(--white);
            border-radius: 8px; margin-bottom: 5px;
        }
        .membro-info { display: flex; flex-direction: column; gap: 5px; }
        .membro-nome { font-weight: bold; font-size: 0.9em; }
        
        /* Bot√µes de dias (D, S, T, Q...) */
        .mini-dias { display: flex; gap: 4px; }
        .mini-dia-btn { 
            width: 24px; height: 24px; font-size: 0.6em; border-radius: 5px; 
            border: 1px solid var(--border); background: #eee; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-weight: bold;
        }
        .mini-dia-btn.active { background: var(--success); color: white; border-color: var(--success); }
        .mini-dia-btn.inactive { background: #f8d7da; color: #721c24; border-color: #f5c6cb; text-decoration: line-through; opacity: 0.6; }
        
        body.dark-mode .mini-dia-btn.inactive { background: #451a1a; color: #f87171; border-color: #7f1d1d; opacity: 1; }

        /* 5. CONFIGURA√á√ïES DE FREQU√äNCIA (CARDS DOS DIAS) */
        .weekdays { display: flex; justify-content: space-between; gap: 4px; margin: 15px 0; width: 100%; }
        .day-card { 
            flex: 1; min-width: 0; background: var(--white); padding: 8px 2px; border: 2px solid var(--border); 
            border-radius: 10px; text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center;
        }
        .day-card.active { border-color: var(--primary); background: rgba(0, 46, 93, 0.1); }
        body.dark-mode .day-card.active { border-color: #60a5fa; background: rgba(96, 165, 250, 0.1); }

        .day-name { font-weight: 800; font-size: 0.7em; margin-bottom: 5px; }
        .day-card input[type="number"] { width: 85%; max-width: 38px; padding: 4px 0; text-align: center; border-radius: 6px; border: 1px solid #ccc; font-size: 0.75em; font-weight: bold; background: white; color: black; }
        
        .label-pess { font-size: 0.55em; color: #888; margin-top: 2px; }
        body.dark-mode .label-pess { color: #cbd5e1; }

        .especial-input-div { display: none; border-top: 1px solid #eee; margin-top: 5px; padding-top: 5px; }

        /* 6. BOT√ïES DE A√á√ÉO */
        .actions { margin: 25px 0; display: flex; gap: 8px; flex-wrap: wrap; }
        .actions button { flex: 1; height: 45px; border-radius: 10px; font-weight: bold; cursor: pointer; border: none; font-size: 0.85em; transition: 0.2s; }
        .btn-generate { background: var(--primary); color: white; }
        .btn-download { background: var(--secondary); color: white; }
        
        .btn-clear { 
            background: #f8f9fa; 
            color: var(--danger); 
            border: 1px solid #eee !important;
        }
        .btn-clear:hover { 
            background: #fff5f5;
            border-color: var(--danger) !important;
            transform: translateY(-2px);
        }
        body.dark-mode .btn-clear {
            background: #1e293b;
            border-color: #334155 !important;
        }
        body.dark-mode .btn-clear:hover {
            background: #451a1a;
            border-color: var(--danger) !important;
        }

        /* 7. TABELA DE RESULTADOS */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; text-align: left; }
        th { background: #f8f9fa; color: var(--primary); padding: 12px 8px; border-bottom: 2px solid var(--primary); }
        body.dark-mode th { background: #334155; color: #fff; border-bottom-color: #60a5fa; }
        td { padding: 12px 8px; border-bottom: 1px solid var(--border); }
        body.dark-mode td { color: #f1f5f9; }
        
        .btn-icon { background: none; border: none; cursor: pointer; font-size: 1.1em; padding: 4px; opacity: 0.7; }
        .titulo-escala-gerada { display: none; color: var(--primary); margin: 10px 0; font-size: 1.5em; font-weight: 800; text-transform: uppercase; }
        body.dark-mode .titulo-escala-gerada { color: #fff; }

        /* 8. EXPORTA√á√ÉO (IMAGEM FINAL) */
        
        /* Container da pr√©via da escala com imagem de fundo */
        #escalaResultado {
            position: relative;
            margin-top: 20px;
            border-radius: 20px;
            overflow: hidden;
            min-height: 400px;
        }
        
        /* Imagem de fundo da pr√©via */
        .bg-imagem-depto {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
            display: none;
        }
        
        /* Overlay de vidro sobre a imagem de fundo */
        .glass-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 2;
            border-radius: 20px;
        }
        
        body.dark-mode .glass-overlay {
            background: rgba(15, 23, 42, 0.9);
        }
        
        /* Conte√∫do sobre a imagem de fundo */
        #tituloEscala, #tabelaEscala {
            position: relative;
            z-index: 3;
        }
        
        /* Container invis√≠vel onde a m√°gica acontece */
        #escala-export {
            position: absolute;
            left: -9999px;
            top: 0;
            width: 800px;
            padding: 40px;
            background-size: cover;
            background-position: center;
            display: block;
            border-radius: 0;
        }

        /* O Vidro da Foto Final */
        .overlay-export {
            background: rgba(255, 255, 255, 0.75); /* Branco bem transparente */
            backdrop-filter: blur(15px) saturate(180%);
            -webkit-backdrop-filter: blur(15px) saturate(180%);
            padding: 30px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        /* Ajuste do Vidro na Exporta√ß√£o se estiver em modo dark */
        body.dark-mode .overlay-export {
            background: rgba(15, 23, 42, 0.8); /* Azul escuro transparente */
            border-color: rgba(255, 255, 255, 0.1);
        }

        /* Classes auxiliares para o print */
        .capturando .no-capture, 
        .capturando .side-controls, 
        .capturando .col-acoes { 
            display: none !important; 
        }

        /* Badges espec√≠ficas para o departamento de Louvor */
        .badge-louvor { 
            font-size: 0.7em; 
            font-weight: 800; 
            text-transform: uppercase; 
            padding: 3px 8px; 
            border-radius: 6px; 
            margin-bottom: 3px; 
            display: inline-block; /* Mant√©m o fundo apenas no tamanho do texto */
            width: fit-content;
        }

        /* Cores vibrantes para o fundo */
        .bg-congregacional { 
            background-color: #002e5d !important; 
            color: #ffffff !important; 
        }

        .bg-especial { 
            background-color: #6f42c1 !important; 
            color: #ffffff !important; 
        }
    </style>
</head>
<body>

<div class="header-app no-capture">
    <div class="side-controls">
        <button class="btn-control btn-theme-toggle" onclick="toggleDarkMode()" title="Mudar Tema">üåì</button>
        <a href="https://www.instagram.com/boavista_iasd/" target="_blank" class="btn-control" title="Instagram">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 0C5.829 0 5.556.01 4.703.048 3.85.088 3.269.222 2.76.42a3.917 3.917 0 0 0-1.417.923A3.927 3.927 0 0 0 .42 2.76C.222 3.268.087 3.85.048 4.7.01 5.555 0 5.827 0 8.001c0 2.172.01 2.444.048 3.297.04.852.174 1.433.372 1.942.205.526.478.972.923 1.417.444.445.89.719 1.416.923.51.198 1.09.333 1.942.372C5.555 15.99 5.827 16 8 16s2.444-.01 3.298-.048c.851-.04 1.434-.174 1.943-.372a3.916 3.916 0 0 0 1.416-.923c.445-.445.718-.891.923-1.417.197-.509.332-1.09.372-1.942C15.99 10.445 16 10.173 16 8s-.01-2.445-.048-3.299c-.04-.851-.175-1.433-.372-1.941a3.926 3.926 0 0 0-.923-1.417A3.911 3.911 0 0 0 13.24.42c-.51-.198-1.092-.333-1.943-.372C10.443.01 10.172 0 7.998 0h.003zm-.717 1.442h.718c2.136 0 2.389.007 3.232.046.78.035 1.204.166 1.486.275.373.145.64.319.92.599.28.28.453.546.598.92.11.281.24.705.275 1.485.039.843.047 1.096.047 3.231s-.008 2.389-.047 3.232c-.035.78-.166 1.203-.275 1.485a2.47 2.47 0 0 1-.599.919c-.28.28-.546.453-.92.598-.282.11-.705.24-1.485.276-.843.038-1.096.047-3.232.047s-2.39-.009-3.233-.047c-.78-.036-1.203-.166-1.485-.276a2.478 2.478 0 0 1-.92-.598 2.48 2.48 0 0 1-.6-.92c-.109-.281-.24-.705-.275-1.485-.038-.843-.046-1.096-.046-3.233 0-2.136.008-2.388.046-3.231.036-.78.166-1.204.276-1.486.145-.373.319-.64.599-.92.28-.28.546-.453.92-.598.282-.11.705-.24 1.485-.276.738-.034 1.024-.044 2.515-.045v.002zm4.988 1.328a.96.96 0 1 0 0 1.92.96.96 0 0 0 0-1.92zm-4.27 1.122a4.109 4.109 0 1 0 0 8.217 4.109 4.109 0 0 0 0-8.217zm0 1.441a2.667 2.667 0 1 1 0 5.334 2.667 2.667 0 0 1 0-5.334z"/></svg>
        </a>
        <a href="https://www.youtube.com/@iasdgoiana" target="_blank" class="btn-control" title="YouTube">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8.051 1.999h.089c.822.003 4.987.033 6.11.335a2.01 2.01 0 0 1 1.415 1.42c.101.38.172.883.22 1.402l.01.104.022.26.008.104c.065.914.073 1.77.074 1.957v.075c-.001.194-.01 1.108-.082 2.06l-.008.105-.009.104c-.05.572-.124 1.14-.235 1.558a2.007 2.007 0 0 1-1.415 1.42c-1.16.312-5.569.334-6.18.335h-.142c-.309 0-1.587-.006-2.927-.052l-.17-.006-.087-.004-.171-.007-.171-.007c-1.11-.049-2.367-.102-3.287-.348a2.007 2.007 0 0 1-1.415-1.419c-.111-.417-.185-.986-.235-1.558L.09 9.82l-.008-.104A31.4 31.4 0 0 1 0 7.68v-.123c.002-.215.01-.958.064-1.778l.007-.103.003-.052.008-.104.022-.26.01-.104c.048-.519.119-1.023.22-1.402a2.007 2.007 0 0 1 1.415-1.42c.487-.13 1.544-.21 2.654-.26l.17-.007.172-.006.086-.003.171-.007A99.788 99.788 0 0 1 7.858 2h.193zM6.4 5.209v4.818l4.157-2.408L6.4 5.209z"/></svg>
        </a>
    </div>

    <img src="https://identidade.adventistas.org/pt/assets/img/iasd_logo.svg" class="logo-header" alt="IASD">
    <h2 style="margin:0; font-size: 1.2em; letter-spacing: 1px;">GERADOR DE ESCALAS</h2>
    <div class="by-header">by comunica√ß√£o boa vista</div>
</div>

<div class="container">
    <div class="no-capture">
        <div class="section-title">üìÖ Per√≠odo e Departamento</div>
        <div class="grid-inputs">
            <div>
                <label>Departamento</label>
                <select id="tipoEscala" onchange="verificarOutros()">
                    <option value="T√©cnicos de Som">üîä T√©cnicos de Som</option>
                    <option value="Proje√ß√£o">üìΩÔ∏è Proje√ß√£o</option>
                    <option value="Escola Sabatina">üìñ Escola Sabatina</option>
                    <option value="Prega√ß√£o">üì¢ Prega√ß√£o</option>
                    <option value="Louvor">üé§ Louvor (Congregacional + Especial)</option>
                    <option value="Recep√ß√£o">ü§ù Recep√ß√£o</option>
                    <option value="Di√°conos">üëî Di√°conos</option>
                    <option value="Limpeza">üßπ Limpeza</option>
                    <option value="Minist√©rio Infantil">üßí Minist√©rio Infantil</option>
                    <option value="Outros">‚ú® Outros...</option>
                </select>
                <input type="text" id="outroTipo" placeholder="Nome do depto" style="display:none; margin-top:8px;">
            </div>
            <div><label>M√™s de Refer√™ncia</label><input type="month" id="selecaoMes" onchange="preencherDatasPeloMes()"></div>
            <div><label>Data In√≠cio</label><input type="date" id="dataInicio"></div>
            <div><label>Data Fim</label><input type="date" id="dataFim"></div>
        </div>
        
        <div class="grid-inputs" style="margin-top: 12px;">
            <div style="grid-column: 1 / -1;">
                <label>Nome da Igreja</label>
                <input type="text" id="nomeIgreja" placeholder="IGREJA ADVENTISTA DO S√âTIMO DIA - BOA VISTA" value="IGREJA ADVENTISTA DO S√âTIMO DIA - BOA VISTA">
            </div>
        </div>

        <div class="section-title">üë• Gest√£o de Equipe</div>
        
        <div class="legenda-dispo">
            <div class="legenda-item"><strong>Guia:</strong> Clique nas letras para definir a disponibilidade semanal.</div>
            <div style="display: flex; gap: 15px; margin-top: 5px;">
                <div class="legenda-item"><span class="mini-dia-btn active">D</span> <span>Dispon√≠vel</span></div>
                <div class="legenda-item"><span class="mini-dia-btn inactive">D</span> <span>Indispon√≠vel</span></div>
            </div>
        </div>

        <div class="cadastro-membros">
            <input type="text" id="novoNome" placeholder="Nome do volunt√°rio...">
            <button onclick="adicionarMembro('geral')" style="width: 100px; border-radius: 10px; background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer;">+ Add</button>
        </div>
        <div class="lista-membros" id="listaMembrosGeral"></div>

        <div id="divLouvorEspecial" style="display:none;">
            <div class="section-title">üåü Equipe Louvor Especial</div>
            <div class="legenda-dispo" style="background: #f3e8ff; border-color: #d8b4fe; color: #6b21a8;">
                <div class="legenda-item"><strong>Observa√ß√£o:</strong> A equipe especial participa nos dias selecionados abaixo, complementando o louvor congregacional.</div>
            </div>
            <div class="cadastro-membros">
                <input type="text" id="novoNomeEsp" placeholder="Nome do volunt√°rio especial...">
                <button onclick="adicionarMembro('especial')" style="width: 100px; border-radius: 10px; background: var(--secondary); color: white; border: none; font-weight: bold; cursor: pointer;">+ Add</button>
            </div>
            <div class="lista-membros" id="listaMembrosEspecial"></div>
        </div>

        <div class="section-title">‚öôÔ∏è Frequ√™ncia (Dias e Pessoas)</div>
        <div class="weekdays" id="diasSelecao"></div>
    </div>

    <div class="actions no-capture">
        <button class="btn-generate" onclick="gerarEscala()">üöÄ Gerar Escala</button>
        <button class="btn-download" onclick="baixarEscala()">üíæ Salvar e Baixar Escala</button>
        <button class="btn-clear" onclick="limparTudo()">‚ö†Ô∏è Limpar Tudo</button>
    </div>

    <div id="escalaResultado">
        <img src="" id="bgImagem" class="bg-imagem-depto" alt="">
        <div class="glass-overlay"></div>
        
        <div style="position: relative; z-index: 3; padding: 20px;">
            <h2 id="tituloEscala" class="titulo-escala-gerada"></h2>
            <table id="tabelaEscala">
                <thead>
                    <tr>
                        <th style="width: 25%;">Data</th>
                        <th style="width: 15%;">Dia</th>
                        <th>Respons√°veis</th>
                        <th class="col-acoes" style="width: 75px;">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal de Edi√ß√£o de Nomes -->
<div id="modalEdicao" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: var(--white); padding: 30px; border-radius: 20px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
        <h3 style="margin: 0 0 20px 0; color: var(--primary); font-size: 1.3em;">Editar Respons√°veis</h3>
        
        <div style="margin-bottom: 15px;">
            <strong style="color: var(--text);">Data:</strong> <span id="modalData" style="color: #666;"></span>
        </div>
        
        <div id="modalNomesAtuais" style="margin-bottom: 20px;">
            <h4 style="margin: 0 0 10px 0; color: var(--text); font-size: 0.9em;">Nomes Atuais:</h4>
            <div id="listaNomesAtuais" style="display: flex; flex-direction: column; gap: 8px;"></div>
        </div>
        
        <div style="margin-bottom: 20px;">
            <h4 style="margin: 0 0 10px 0; color: var(--text); font-size: 0.9em;">Adicionar Volunt√°rio:</h4>
            <select id="selectVoluntarios" onchange="adicionarVoluntarioModal()" style="width: 100%; padding: 10px; border: 2px solid var(--border); border-radius: 10px;">
                <option value="">Selecione um volunt√°rio para adicionar...</option>
            </select>
        </div>
        
        <div style="display: flex; gap: 10px;">
            <button onclick="salvarEdicaoModal()" style="flex: 1; padding: 12px; background: var(--success); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold;">‚úÖ Salvar</button>
            <button onclick="fecharModalEdicao()" style="flex: 1; padding: 12px; background: var(--danger); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold;">‚ùå Cancelar</button>
        </div>
    </div>
</div>

<script>
    const imagensDepartamentos = {
        "T√©cnicos de Som": "mesa-som.png",
        "Escola Sabatina": "sabatina.png",
        "Prega√ß√£o": "pregacao.jpg",
        "Louvor": "louvor.png",
        "Proje√ß√£o": "projecao.jpg",
        "Recep√ß√£o": "recepcao.jpg",
        "Di√°conos": "diacono.jpg",
        "Limpeza": "limpeza.jpeg",
        "Minist√©rio Infantil": "infantil.jpg",
        "Outros": "" // Pode deixar vazio ou uma imagem padr√£o
    };

    /* ============================================================
       1. CONFIGURA√á√ïES INICIAIS E VARI√ÅVEIS GLOBAIS
       ============================================================ */
    const diasSemanaNome = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "S√°b"];
    let membrosGeral = JSON.parse(localStorage.getItem('membros_geral')) || [];
    let membrosEspecial = JSON.parse(localStorage.getItem('membros_especial')) || [];
    
    // Vari√°veis para o modal de edi√ß√£o
    let linhaEditando = null;
    let nomesAtuaisModal = [];
    let tipoEscalaAtual = '';

    // Fun√ß√£o executada ao abrir a p√°gina
    window.onload = () => {
        // 1. Tema (Sempre primeiro para evitar "piscada" branca)
        if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
        
        // 2. Criar os cards primeiro! (Para que eles existam no HTML)
        const containerDias = document.getElementById('diasSelecao');
        containerDias.innerHTML = ""; // Limpa antes de preencher
        diasSemanaNome.forEach((dia, index) => {
            const isDefault = [0,3,6].includes(index); 
            containerDias.innerHTML += `
                <div class="day-card ${isDefault ? 'active' : ''}" id="card-${index}" onclick="toggleCard(${index})">
                    <span class="day-name">${dia}</span>
                    <input type="checkbox" id="dia-${index}" ${isDefault ? 'checked' : ''} style="display:none">
                    <label class="label-pess">Pess.</label>
                    <input type="number" id="qtd-${index}" value="1" min="1" onclick="event.stopPropagation()">
                    <div class="especial-input-div" id="esp-div-${index}">
                        <label class="label-pess">Esp.</label>
                        <input type="number" id="qtd-esp-${index}" value="1" min="0" onclick="event.stopPropagation()">
                    </div>
                </div>
            `;
        });

        // 3. Recuperar membros
        renderizarMembros('geral');
        renderizarMembros('especial');

        // 4. Recuperar Configura√ß√µes (Agora o verificarOutros vai funcionar)
        const config = JSON.parse(localStorage.getItem('escala_config'));
        if(config) {
            document.getElementById('tipoEscala').value = config.tipoEscala;
            document.getElementById('outroTipo').value = config.outroTipo;
            document.getElementById('selecaoMes').value = config.selecaoMes;
            document.getElementById('dataInicio').value = config.dataInicio;
            document.getElementById('dataFim').value = config.dataFim;
            document.getElementById('nomeIgreja').value = config.nomeIgreja || "IGREJA ADVENTISTA DO S√âTIMO DIA - BOA VISTA";
            verificarOutros(); // Agora os elementos esp-div-X j√° existem!
        } else {
            const hoje = new Date();
            document.getElementById('selecaoMes').value = hoje.toISOString().substring(0, 7);
            preencherDatasPeloMes();
        }

        // 5. Recuperar a Escala Gerada
        const escalaHTML = localStorage.getItem('escala_salva_html');
        const tituloSalvo = localStorage.getItem('escala_titulo_salvo');
        if(escalaHTML && escalaHTML.trim() !== "") {
            document.querySelector('#tabelaEscala tbody').innerHTML = escalaHTML;
            document.getElementById('tituloEscala').innerText = tituloSalvo || "ESCALA";
            document.getElementById('tituloEscala').style.display = "block";
        }
    };

    /* ============================================================
       2. FUN√á√ïES DE GEST√ÉO DE MEMBROS (ADD / REMOVE / RENDER)
       ============================================================ */
    function adicionarMembro(tipo) {
        const idCampo = tipo === 'geral' ? 'novoNome' : 'novoNomeEsp';
        const input = document.getElementById(idCampo);
        const nome = input.value.trim();
        
        if(!nome) {
            input.style.borderColor = 'var(--danger)';
            setTimeout(() => input.style.borderColor = 'var(--border)', 2000);
            return;
        }
        
        // Verificar se nome j√° existe no mesmo grupo
        const array = tipo === 'geral' ? membrosGeral : membrosEspecial;
        if(array.some(m => m.nome.toLowerCase() === nome.toLowerCase())) {
            alert(`"${nome}" j√° est√° cadastrado na equipe ${tipo === 'geral' ? 'congregacional' : 'especial'}!`);
            return;
        }
        
        const novo = { nome: nome, disponivel: [0,1,2,3,4,5,6] };
        if(tipo === 'geral') membrosGeral.push(novo);
        else membrosEspecial.push(novo);
        
        input.value = "";
        salvarDados();
        renderizarMembros(tipo);
        
        // Feedback visual
        input.style.borderColor = 'var(--success)';
        setTimeout(() => input.style.borderColor = 'var(--border)', 1500);
    }

    function renderizarMembros(tipo) {
        const lista = document.getElementById(tipo === 'geral' ? 'listaMembrosGeral' : 'listaMembrosEspecial');
        const array = tipo === 'geral' ? membrosGeral : membrosEspecial;
        const isEspecial = tipo === 'especial';
        
        lista.innerHTML = array.length ? "" : `<div style='text-align:center; color:#999; padding:10px; font-size:0.8em;'>Nenhum volunt√°rio ${isEspecial ? 'especial' : 'cadastrado'}.</div>`;
        
        array.forEach((m, idx) => {
            let botoesDias = "";
            diasSemanaNome.forEach((dia, dIdx) => {
                const ativo = m.disponivel.includes(dIdx);
                botoesDias += `<button class="mini-dia-btn ${ativo ? 'active' : 'inactive'}" onclick="toggleDiaMembro('${tipo}', ${idx}, ${dIdx})">${dia[0]}</button>`;
            });
            
            const estiloCard = isEspecial ? 'background: linear-gradient(135deg, rgba(111, 66, 193, 0.1), rgba(111, 66, 193, 0.05)); border: 2px solid var(--secondary);' : '';
            const estiloNome = isEspecial ? 'color: var(--secondary);' : '';
            
            lista.innerHTML += `<div class="membro-item" style="${estiloCard}">
                <div class="membro-info">
                    <span class="membro-nome" style="${estiloNome}">${isEspecial ? 'üåü ' : ''}${m.nome}</span>
                    <div class="mini-dias">${botoesDias}</div>
                </div>
                <button onclick="removerMembro('${tipo}', ${idx})" style="border:none; background:none; cursor:pointer; color:var(--danger)">üóëÔ∏è</button>
            </div>`;
        });
    }

    function toggleDiaMembro(tipo, mIdx, dIdx) {
        const array = tipo === 'geral' ? membrosGeral : membrosEspecial;
        const pos = array[mIdx].disponivel.indexOf(dIdx);
        if(pos > -1) array[mIdx].disponivel.splice(pos, 1);
        else array[mIdx].disponivel.push(dIdx);
        salvarDados();
        renderizarMembros(tipo);
    }

    function removerMembro(tipo, idx) {
        if(tipo === 'geral') membrosGeral.splice(idx, 1);
        else membrosEspecial.splice(idx, 1);
        salvarDados();
        renderizarMembros(tipo);
    }

    /* ============================================================
       3. PERSIST√äNCIA E CONFIGURA√á√ïES DE UI
       ============================================================ */
    function salvarDados() {
        // Salva Membros
        localStorage.setItem('membros_geral', JSON.stringify(membrosGeral));
        localStorage.setItem('membros_especial', JSON.stringify(membrosEspecial));

        // Salva Configura√ß√µes do Formul√°rio
        const configuracoes = {
            tipoEscala: document.getElementById('tipoEscala').value,
            outroTipo: document.getElementById('outroTipo').value,
            selecaoMes: document.getElementById('selecaoMes').value,
            dataInicio: document.getElementById('dataInicio').value,
            dataFim: document.getElementById('dataFim').value,
            nomeIgreja: document.getElementById('nomeIgreja').value
        };
        localStorage.setItem('escala_config', JSON.stringify(configuracoes));

        // Salva a Escala Gerada (o HTML da tabela)
        const corpoTabela = document.querySelector('#tabelaEscala tbody').innerHTML;
        const tituloEscala = document.getElementById('tituloEscala').innerText;
        localStorage.setItem('escala_salva_html', corpoTabela);
        localStorage.setItem('escala_titulo_salvo', tituloEscala);
    }

    function verificarOutros() {
        const sel = document.getElementById('tipoEscala');
        const isLouvor = sel.value === 'Louvor';
        document.getElementById('outroTipo').style.display = (sel.value === 'Outros') ? 'block' : 'none';
        document.getElementById('divLouvorEspecial').style.display = isLouvor ? 'block' : 'none';
        for(let i=0; i<7; i++) document.getElementById(`esp-div-${i}`).style.display = isLouvor ? 'block' : 'none';
    }

    function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    }

    function toggleCard(index) {
        const cb = document.getElementById(`dia-${index}`);
        cb.checked = !cb.checked;
        document.getElementById(`card-${index}`).classList.toggle('active');
    }

    function preencherDatasPeloMes() {
        const [ano, mes] = document.getElementById('selecaoMes').value.split('-');
        document.getElementById('dataInicio').value = `${ano}-${mes}-01`;
        document.getElementById('dataFim').value = new Date(ano, mes, 0).toISOString().substring(0, 10);
    }

    /* ============================================================
       4. L√ìGICA DE GERA√á√ÉO DA ESCALA (O CORA√á√ÉO DO APP)
       ============================================================ */
    function gerarEscala() {
        if(membrosGeral.length === 0) return alert("Por favor, cadastre volunt√°rios na equipe.");
        
        const deptoSelect = document.getElementById('tipoEscala');
        const valorSelecionado = deptoSelect.value; // Ex: 'Louvor', 'Di√°conos'...
        const isLouvor = valorSelecionado === 'Louvor';
        let nomeFinal = deptoSelect.options[deptoSelect.selectedIndex].text;
        
        // --- NOVO: L√≥gica da Imagem de Fundo ---
        const imgElement = document.getElementById('bgImagem');
        if (imagensDepartamentos[valorSelecionado]) {
            imgElement.src = '/IMG/' + imagensDepartamentos[valorSelecionado];
            imgElement.style.display = "block";
        } else {
            imgElement.style.display = "none"; // Esconde se n√£o houver imagem mapeada
        }
        // ---------------------------------------

        if (valorSelecionado === 'Outros') {
            const outroNome = document.getElementById('outroTipo').value.trim();
            nomeFinal = outroNome ? "‚ú® " + outroNome : "Outros";
        }

        document.getElementById('tituloEscala').innerText = "ESCALA: " + nomeFinal;
        document.getElementById('tituloEscala').style.display = "block";
        
        const tbody = document.querySelector('#tabelaEscala tbody');
        tbody.innerHTML = "";

        let contagemGeral = {};
        let contagemEspecial = {};
        let dataAtual = new Date(document.getElementById('dataInicio').value + "T00:00:00");
        const dataFimObj = new Date(document.getElementById('dataFim').value + "T00:00:00");

        while (dataAtual <= dataFimObj) {
            const diaSemana = dataAtual.getDay();
            
            if (document.getElementById(`dia-${diaSemana}`).checked) {
                const qtdCong = parseInt(document.getElementById(`qtd-${diaSemana}`).value) || 1;
                const qtdEsp = isLouvor ? (parseInt(document.getElementById(`qtd-esp-${diaSemana}`).value) || 0) : 0;

                let aptosGeral = membrosGeral.filter(m => m.disponivel.includes(diaSemana));
                let aptosEsp = membrosEspecial.filter(m => m.disponivel.includes(diaSemana));

                let escolhidosCong = aptosGeral
                    .sort((a, b) => (contagemGeral[a.nome] || 0) - (contagemGeral[b.nome] || 0) || (Math.random() - 0.5))
                    .slice(0, qtdCong)
                    .map(m => {
                        contagemGeral[m.nome] = (contagemGeral[m.nome] || 0) + 1;
                        return m.nome;
                    });

                let escolhidosEsp = isLouvor ? aptosEsp
                    .sort((a, b) => (contagemEspecial[a.nome] || 0) - (contagemEspecial[b.nome] || 0) || (Math.random() - 0.5))
                    .slice(0, qtdEsp)
                    .map(m => {
                        contagemEspecial[m.nome] = (contagemEspecial[m.nome] || 0) + 1;
                        return m.nome;
                    }) : [];

                const row = document.createElement('tr');
                row.dataset.isLouvor = isLouvor;
                row.innerHTML = `
                    <td style="font-weight:700">${dataAtual.toLocaleDateString('pt-BR')}</td>
                    <td style="color:#666">${diasSemanaNome[diaSemana]}</td>
                    <td class="nomes-td">
                        ${isLouvor ? `<div class="cong-txt"><span class="badge-louvor bg-congregacional">Congregacional:</span> <span class="val">${escolhidosCong.join(', ') || '---'}</span></div>` : escolhidosCong.join(', ') || '---'}
                        ${escolhidosEsp.length > 0 ? `<div class="esp-txt" style="margin-top:5px;"><span class="badge-louvor bg-especial">Especial:</span> <span class="val">${escolhidosEsp.join(', ')}</span></div>` : ''}
                    </td>
                    <td class="col-acoes">
                        <button class="btn-icon" onclick="editarLinha(this)">‚úèÔ∏è</button>
                        <button class="btn-icon" onclick="excluirLinha(this)">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(row);
            }
            dataAtual.setDate(dataAtual.getDate() + 1);
        }
        
        // Salva no LocalStorage para n√£o perder ao recarregar
        salvarDados();
    }

    /* ============================================================
       5. FUN√á√ïES DE EDI√á√ÉO E EXPORTA√á√ÉO
       ============================================================ */
    function editarLinha(btn) {
        const row = btn.closest('tr');
        const td = row.querySelector('.nomes-td');
        const dataCell = row.querySelector('td:first-child');
        const diaCell = row.querySelector('td:nth-child(2)');
        
        // Configurar vari√°veis do modal
        linhaEditando = row;
        tipoEscalaAtual = document.getElementById('tipoEscala').value;
        nomesAtuaisModal = [];
        
        // Extrair nomes atuais
        if (row.dataset.isLouvor === "true") {
            // Para Louvor, extrair congregacional e especial separadamente
            const congElement = td.querySelector('.cong-txt .val');
            const espElement = td.querySelector('.esp-txt .val');
            
            if (congElement) {
                const congNomes = congElement.innerText.split(',').filter(n => n.trim() && n.trim() !== '---');
                nomesAtuaisModal = nomesAtuaisModal.concat(congNomes.map(n => ({ nome: n.trim(), tipo: 'congregacional' })));
            }
            if (espElement) {
                const espNomes = espElement.innerText.split(',').filter(n => n.trim() && n.trim() !== '---');
                nomesAtuaisModal = nomesAtuaisModal.concat(espNomes.map(n => ({ nome: n.trim(), tipo: 'especial' })));
            }
        } else {
            // Para outros departamentos
            const nomesTexto = td.innerText.split(',').filter(n => n.trim() && n.trim() !== '---');
            nomesAtuaisModal = nomesTexto.map(n => ({ nome: n.trim(), tipo: 'geral' }));
        }
        
        // Preencher informa√ß√µes do modal
        document.getElementById('modalData').innerText = `${dataCell.innerText} (${diaCell.innerText})`;
        
        // Preencher lista de nomes atuais
        atualizarListaNomesAtuais();
        
        // Preencher select de volunt√°rios dispon√≠veis
        popularSelectVoluntarios();
        
        // Abrir modal
        document.getElementById('modalEdicao').style.display = 'flex';
    }
    
    function atualizarListaNomesAtuais() {
        const container = document.getElementById('listaNomesAtuais');
        container.innerHTML = '';
        
        if (nomesAtuaisModal.length === 0) {
            container.innerHTML = '<div style="color: #999; font-style: italic;">Nenhum volunt√°rio adicionado</div>';
            return;
        }
        
        nomesAtuaisModal.forEach((item, index) => {
            const div = document.createElement('div');
            div.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--input-bg); border-radius: 8px; border: 1px solid var(--border);';
            
            const tipoLabel = item.tipo === 'congregacional' ? 'üé§' : item.tipo === 'especial' ? 'üåü' : '';
            div.innerHTML = `
                <span>${tipoLabel} ${item.nome}</span>
                <button onclick="removerNomeModal(${index})" style="background: var(--danger); color: white; border: none; border-radius: 5px; padding: 4px 8px; cursor: pointer;">üóëÔ∏è</button>
            `;
            container.appendChild(div);
        });
    }
    
    function popularSelectVoluntarios() {
        const select = document.getElementById('selectVoluntarios');
        select.innerHTML = '<option value="">Selecione um volunt√°rio...</option>';
        
        let voluntariosDisponiveis = [];
        
        if (tipoEscalaAtual === 'Louvor') {
            // Para Louvor, incluir ambos os grupos
            voluntariosDisponiveis = [
                ...membrosGeral.map(m => ({ nome: m.nome, tipo: 'congregacional' })),
                ...membrosEspecial.map(m => ({ nome: m.nome, tipo: 'especial' }))
            ];
        } else {
            // Para outros departamentos
            voluntariosDisponiveis = membrosGeral.map(m => ({ nome: m.nome, tipo: 'geral' }));
        }
        
        // Remover volunt√°rios j√° adicionados
        const nomesJaAdicionados = nomesAtuaisModal.map(item => item.nome);
        voluntariosDisponiveis = voluntariosDisponiveis.filter(v => !nomesJaAdicionados.includes(v.nome));
        
        voluntariosDisponiveis.forEach(voluntario => {
            const option = document.createElement('option');
            const tipoLabel = voluntario.tipo === 'congregacional' ? 'üé§' : voluntario.tipo === 'especial' ? 'üåü' : '';
            option.value = JSON.stringify(voluntario);
            option.innerText = `${tipoLabel} ${voluntario.nome}`;
            select.appendChild(option);
        });
    }
    
    function adicionarVoluntarioModal() {
        const select = document.getElementById('selectVoluntarios');
        if (select.value) {
            const voluntario = JSON.parse(select.value);
            nomesAtuaisModal.push(voluntario);
            atualizarListaNomesAtuais();
            popularSelectVoluntarios(); // Atualizar para remover da lista
            
            // Resetar o select para a op√ß√£o padr√£o
            select.value = "";
        }
    }
    
    function removerNomeModal(index) {
        nomesAtuaisModal.splice(index, 1);
        atualizarListaNomesAtuais();
        popularSelectVoluntarios(); // Atualizar para adicionar de volta √† lista
    }
    
    function salvarEdicaoModal() {
        if (!linhaEditando) return;
        
        const td = linhaEditando.querySelector('.nomes-td');
        
        if (linhaEditando.dataset.isLouvor === "true") {
            // Separar por tipo para Louvor
            const congregacionais = nomesAtuaisModal.filter(n => n.tipo === 'congregacional').map(n => n.nome);
            const especiais = nomesAtuaisModal.filter(n => n.tipo === 'especial').map(n => n.nome);
            
            td.innerHTML = `
                <div class="cong-txt"><span class="badge-louvor bg-congregacional">Congregacional:</span> <span class="val">${congregacionais.join(', ') || '---'}</span></div>
                ${especiais.length > 0 ? `<div class="esp-txt" style="margin-top:5px;"><span class="badge-louvor bg-especial">Especial:</span> <span class="val">${especiais.join(', ')}</span></div>` : ''}
            `;
        } else {
            // Para outros departamentos
            const nomes = nomesAtuaisModal.map(n => n.nome);
            td.innerText = nomes.join(', ') || '---';
        }
        
        // Salvar altera√ß√µes
        salvarDados();
        fecharModalEdicao();
    }
    
    function fecharModalEdicao() {
        document.getElementById('modalEdicao').style.display = 'none';
        linhaEditando = null;
        nomesAtuaisModal = [];
        tipoEscalaAtual = '';
    }

    async function baixarEscala() {
        const depto = document.getElementById('tipoEscala').value;
        const valorMes = document.getElementById('selecaoMes').value; // Ex: "2026-02"
        
        // --- NOVA L√ìGICA DE FORMATA√á√ÉO DE M√äS ---
        const mesesNomes = [
            "Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho",
            "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
        ];
        
        let mesExibicao = valorMes; // Caso algo d√™ errado, ele mostra o original
        if (valorMes.includes('-')) {
            const [ano, mes] = valorMes.split('-');
            const nomeMes = mesesNomes[parseInt(mes) - 1];
            mesExibicao = `${nomeMes} de ${ano}`;
        }
        // ----------------------------------------
        const nomeImg = imagensDepartamentos[depto] || "sabatina.jpg";
        const nomeIgreja = document.getElementById('nomeIgreja').value || "IGREJA ADVENTISTA DO S√âTIMO DIA - BOA VISTA";
        
        // 1. Cria a √°rea de exporta√ß√£o tempor√°ria
        const exportArea = document.createElement('div');
        exportArea.id = 'escala-export';
        exportArea.style.backgroundImage = `url('/IMG/${nomeImg}')`;

        // 2. Clona as linhas da tabela (removendo a coluna de 'A√ß√µes' para a foto ficar limpa)
        let linhasHtml = "";
        document.querySelectorAll('#tabelaEscala tbody tr').forEach(tr => {
        const tds = tr.querySelectorAll('td');
        if(tds.length >= 3) {
            // Pegamos o conte√∫do da c√©lula de nomes
            const nomesConteudo = tds[2].innerHTML; 

            linhasHtml += `
                <tr>
                    <td style="padding:12px; border-bottom:1px solid rgba(0,0,0,0.1); font-weight:bold; vertical-align: top;">
                        ${tds[0].innerText}
                    </td>
                    <td style="padding:12px; border-bottom:1px solid rgba(0,0,0,0.1); vertical-align: top;">
                        ${tds[1].innerText}
                    </td>
                    <td style="padding:12px; border-bottom:1px solid rgba(0,0,0,0.1); vertical-align: top;">
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            ${nomesConteudo}
                        </div>
                    </td>
                </tr>`;
        }
    });

        // 3. Monta o HTML do que ser√° a imagem
        exportArea.innerHTML = `
            <div class="overlay-export">
                <h1 style="text-align:center; margin:0; font-family: sans-serif;">ESCALA: ${depto.toUpperCase()}</h1>
                <p style="text-align:center; color:#666; margin-bottom:20px; font-family: sans-serif;">M√™s de Refer√™ncia: ${mesExibicao}</p>
                <table style="width:100%; border-collapse: collapse; font-family: sans-serif;">
                    <thead>
                        <tr style="background:#002e5d; color:white;">
                            <th style="padding:12px; text-align:left;">Data</th>
                            <th style="padding:12px; text-align:left;">Dia</th>
                            <th style="padding:12px; text-align:left;">Respons√°veis</th>
                        </tr>
                    </thead>
                    <tbody>${linhasHtml}</tbody>
                </table>
                <div style="margin-top:30px; text-align:center; font-family: sans-serif; font-size:12px; font-weight:bold; border-top: 1px solid #ccc; padding-top: 10px;">
                    ${nomeIgreja.toUpperCase()}
                </div>
            </div>`;

        document.body.appendChild(exportArea);

        // 4. Aguarda um pouco para a imagem carregar e tira o print
        setTimeout(() => {
            html2canvas(exportArea, { 
                scale: 2, 
                useCORS: true, 
                allowTaint: true 
            }).then(canvas => {
                const link = document.createElement('a');
                const nomeArquivo = `Escala ${depto} - ${mesExibicao.replace(/[^a-zA-Z0-9]/g, ' ')}.png`;
                link.download = nomeArquivo;
                link.href = canvas.toDataURL("image/png");
                link.click();
                
                // 5. Remove a √°rea tempor√°ria
                document.body.removeChild(exportArea);
            });
        }, 600);
    }
</script>
</body>
</html>
